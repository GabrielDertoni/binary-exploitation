#include <getopt.h>
#include <unistd.h>
#include <assert.h>

#include "common.h"
#include "game_server.h"
#include "fen.h"

int main(int argc, char* const argv[]) {
    struct option longopts[2];
    memset(longopts, 0, sizeof(longopts));

    longopts[0].name = "fen";
    longopts[0].has_arg = true;
    longopts[0].flag = NULL;
    longopts[0].val = 0;

    char fen_string[MAX_FEN_LENGTH + 1];
    strcpy(fen_string, FEN_STARTING);
    bool is_startpos = true;

    int opt;
    while ((opt = getopt_long(argc, argv, "f:", longopts, NULL)) != -1) {
        switch (opt) {
            case 0:
                strcpy(fen_string, optarg);
                is_startpos = strcmp(fen_string, FEN_STARTING) == 0;
                break;

            default: /* '?' */
                fprintf(stderr, "opt=%d\n", opt);
                fprintf(stderr, "Usage: %s [-f fen]\n", argv[0]);
                return EXIT_FAILURE;
        }
    }

    puts("~== ENGINE CHESS ==~");

    int sockfd = socket(AF_INET, SOCK_STREAM, 0);
    if (sockfd == -1) {
        perror("socket");
        return EXIT_FAILURE;
    }
    int option = 1;
    if (setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &option, sizeof(option)) < 0) {
        perror("setsockopt");
        return EXIT_FAILURE;
    }
    struct sockaddr_in servaddr;
    servaddr.sin_family = AF_INET;
    servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
    servaddr.sin_port = htons(8080);

    if (bind(sockfd, (struct sockaddr*)&servaddr, sizeof(servaddr)) != 0) {
        perror("bind");
        return EXIT_FAILURE;
    }

    if (listen(sockfd, 5) != 0) {
        perror("listen");
        return EXIT_FAILURE;
    }

    printf("listening on %d\n", 8080);

    struct sockaddr_in cli;
    socklen_t len = sizeof(cli);
    while (1) {
        int connfd = accept(sockfd, (struct sockaddr*)&cli, &len);
        if (connfd < 0) {
            perror("accept");
            return EXIT_FAILURE;
        }

        fprintf(stderr, "[info] accepted connection\n");

        GameServer server;
        if (!game_server_init_from_fen(&server, fen_string)) {
            fprintf(stderr, "[error]: failed to initialize the game server\n");
            return EXIT_FAILURE;
        }
        server.is_startpos = is_startpos;

        server.uci_in = fdopen(connfd, "r");
        int fd_out = dup(connfd);
        if (fd_out < 0) {
            perror("dup");
            return EXIT_FAILURE;
        }
        server.uci_out = fdopen(fd_out, "w");

        game_server_setup_uci(&server);
        while (game_server_update(&server) && !server.is_done);

        fprintf(stderr, "[info] game finished\n");

        game_server_deinit(&server);
        fclose(server.uci_in);
        fclose(server.uci_out);
    }

    return 0;
}
