#include "uci.h"

const char* uci_command_kind_to_string[] = {
    // gui
    [UCI_INIT]           = "uci",
    [UCI_DEBUG]          = "debug",
    [UCI_ISREADY]        = "isready",
    [UCI_SETOPTION]      = "setoption",
    [UCI_POSITION]       = "position",
    [UCI_GO]             = "go",
    [UCI_STOP]           = "stop",
    [UCI_PONDERHIT]      = "ponderhit",
    [UCI_QUIT]           = "quit",

    // engine
    [UCI_OK]             = "uciok",
    [UCI_READYOK]        = "readyok",
    [UCI_ID]             = "id",
    [UCI_BESTMOVE]       = "bestmove",
    [UCI_COPYPROTECTION] = "copyprotection",
    [UCI_INFO]           = "info",
    [UCI_OPTION]         = "option",

    [UCI_EMPTY]          = "(emtpy)",
};

bool uci_parse_command_kind(const char* command, UciCommandKind* out) {
    if (*command == '\0' || *command == ' ' || *command == '\n') return UCI_EMPTY;
    for (int kind = 0; kind < UCI_COUNT; kind++) {
        if (strcmp(command, uci_command_kind_to_string[kind]) == 0) {
            *out = kind;
            return true;
        }
    }
    return false;
}

bool uci_read_command(UciCommand* out) {
    char command[UCI_MAX_CMD_SIZE + 1];
    ASSERT(scanf("%s", command) != EOF);
    if (!uci_parse_command_kind(command, &out->kind)) return false;

    char* linebuf = NULL;
    size_t bufcap = 0;
    ssize_t len = getline(&linebuf, &bufcap, stdin);
    ASSERT(len != EOF);
    if (feof(stdin)) return false;

    char* args = linebuf;
    ASSERT(*args == '\n' || *(args++) == ' ');

    switch (out->kind) {
        case UCI_OK:
        case UCI_EMPTY:
        case UCI_READYOK:
        case UCI_COPYPROTECTION:
            break;
        case UCI_BESTMOVE: {
            out->bestmove.move = MK_MOVE(strsep(&args, " \n\r"));
            char* s = strsep(&args, " \n\r");
            if (s && *s != '\0') {
                ASSERT(strcmp(s, "ponder") == 0);
                out->bestmove.has_ponder = true;
                out->bestmove.ponder = MK_MOVE(strsep(&args, " \n\r"));
            }
            return true;
        }
        case UCI_ID: {
            out->id.name = NULL;
            out->id.author = NULL;
            char* s = strsep(&args, " ");
            ASSERT(s);
            if (strcmp(s, "name") == 0) {
                out->id.name = strsep(&args, " ");
                ASSERT(out->id.name);
            } else if (strcmp(s, "author") == 0) {
                out->id.author = strsep(&args, " ");
                ASSERT(out->id.author);
            }
            return true;
        }
        case UCI_INFO:
            break;
        case UCI_OPTION:
            out->other = args;
            break;
        default:
            return false;
    }
    return true;
}